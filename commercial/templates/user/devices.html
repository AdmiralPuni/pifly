<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>NoFly</title>


    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/custom.css">
    <link rel="stylesheet" href="/static/css/upalette.css">
</head>

<body class="bg-ni-sh" style="height:100vh;">
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog  modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="form-serial_number" class="form-label">Nomer Seri Perangkat</label>
                        <input type="text" class="form-control" id="form-serial_number">
                    </div>
                    <div class="mb-3">
                        <label for="form-name" class="form-label">Nama</label>
                        <input type="text" class="form-control" id="form-name">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="btn-new_device">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="update-modal" tabindex="-1" aria-labelledby="update-modal" aria-hidden="true">
        <div class="modal-dialog  modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="update-modal">Modal title</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="update-serial_number" class="form-label">Nomer Seri Perangkat</label>
                        <input type="text" class="form-control" id="update-serial_number">
                    </div>
                    <div class="mb-3">
                        <label for="update-name" class="form-label">Nama</label>
                        <input type="text" class="form-control" id="update-name">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="btn-update_name">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container p-0 bg-white h-100 shadow">
        <div class="row row-cols-1 m-0 h-100">
            <div class="col p-0 h-100">
                <div class="d-flex justify-content-start h-100 w-100 ">
                    <div class="d-none d-md-flex border-end border-ni-ri bg-dark h-100" style="min-width: 20%;">
                        {% include('user/components/nav.html') %}
                    </div>
                    <div class="flex-fill p-2 h-100" style="overflow-y: scroll;">
                        <div class="d-flex mb-3 justify-content-between align-items-center p-2 border-bottom border-ni-ri">
                            <span class="fs-5">
                                Daftar Perangkat
                            </span>
                            <button class="btn btn-primary py-1" data-bs-toggle="modal" data-bs-target="#exampleModal">
                                <i class="bi bi-plus-circle"></i> Tambah
                            </button>
                        </div>
                        <div class="d-flex flex-column" id="device-container">
                            <div class="w-100 border rounded border-ni-ri mb-3">
                                <div class="d-flex justify-content-between p-2 border-bottom border-ni-ri">
                                    <span class="fs-5 fw-bold" id="device-'+device.serial_number+'-name">
                                        Perangkat 1
                                    </span>
                                    <span class="fs-5" id="device-'+device.serial_number+'-serial">
                                        0329402348234
                                    </span>
                                </div>
                                <div class="row row-cols-1 row-cols-md-3 m-0 p-2">
                                    <div class="col ps-md-0 mb-2 mb-md-0">
                                        <div class="d-flex justify-content-between fs-5">
                                            <span>
                                                Baterai
                                            </span>
                                            <span>
                                                95%
                                            </span>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" id="device-'+device.serial_number+'-battery" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                    <div class="col mb-2 mb-md-0">
                                        <div class="d-flex justify-content-between fs-5">
                                            <span>
                                                Cairan
                                            </span>
                                            <span>
                                                95%
                                            </span>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" id="device-'+device.serial_number+'-water" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                    <div class="col pe-md-0 mb-2 mb-md-0">
                                        <div class="d-flex justify-content-between fs-5">
                                            <span>
                                                Interval
                                            </span>
                                            <span>
                                                95%
                                            </span>
                                        </div>
                                        <select class="form-select py-1" id="device-'+device.serial_number+'-interval">
                                            <option value="-1">Always Off</option>
                                            <option value="0">Always On</option>
                                            <option value="5">5 Detik</option>
                                            <option value="15">15 Detik</option>
                                            <option value="30">30 Detik</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between p-2 border-top border-ni-ri">
                                    <button class="btn btn-primary py-1">
                                        <i class="bi bi-info-circle"></i> Informasi
                                    </button>
                                    <button class="btn btn-danger py-1">
                                        <i class="bi bi-x-circle"></i> Hapus
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col p-0">

            </div>
        </div>
        {% include('user/components/nav-mobile.html') %}
    </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="/static/js/user.js"></script>
<script>
    $(document).ready(function() {
        load_devices();

        setInterval(function() {
            updater();
        }, 1000);
    });


    //on btn new device
    $('#btn-new_device').click(function(){
        var serial_number = $('#form-serial_number').val();
        var name = $('#form-name').val();
        $.ajax({
            url: '/api/device/add',
            type: 'POST',
            data: {
                serial_number: serial_number,
                name: name
            },
            dataType: 'json',
            success: function(data){
                console.log(data);
                alert(data.message);

                //empty and close modal
                $('#form-serial_number').val('');
                $('#form-name').val('');
                $('#exampleModal').modal('hide');

                load_devices();
            }
        });
    });

    function updater(){
        $.ajax({
            url: '/api/device/my',
            type: 'GET',
            dataType: 'json',
            success: function(data){
                //console.log(data);
                $.each(data.devices, function(index, device){
                    $('#device-'+device.serial_number+'-name').text(device.name);
                    $('#device-'+device.serial_number+'-serial').text(device.serial_number);
                    $('#device-'+device.serial_number+'-battery').css('width', device.battery+'%');
                    $('#device-'+device.serial_number+'-water').css('width', device.water+'%');
                    $('#device-'+device.serial_number+'-interval').val(device.interval);
                    //if radar is null set to 0
                    if(device.radar == null){
                        device.radar = 0;
                    }
                    $('#device-'+device.serial_number+'-radar').html(device.radar);

                    //notification
                    if(device.battery <= 20 && device.water <= 20){
                        $('#device-'+device.serial_number+'-notification').html('Low Battery & Water');
                        //change bg from primary to danger
                        $('#device-'+device.serial_number+'-notification').removeClass('bg-primary');
                        $('#device-'+device.serial_number+'-notification').addClass('bg-danger');
                    }else if(device.battery <= 20){
                        $('#device-'+device.serial_number+'-notification').html('Low Battery');
                        $('#device-'+device.serial_number+'-notification').removeClass('bg-primary');
                        $('#device-'+device.serial_number+'-notification').addClass('bg-danger');
                    }else if(device.water <= 20){
                        $('#device-'+device.serial_number+'-notification').html('Low Water');
                        $('#device-'+device.serial_number+'-notification').removeClass('bg-primary');
                        $('#device-'+device.serial_number+'-notification').addClass('bg-danger');
                    }else{
                        $('#device-'+device.serial_number+'-notification').html('');
                        $('#device-'+device.serial_number+'-notification').removeClass('bg-danger');
                        $('#device-'+device.serial_number+'-notification').addClass('bg-primary');
                    }


                    //update texts
                    $('#device-'+device.serial_number+'-battery-text').text(device.battery+'%');
                    $('#device-'+device.serial_number+'-water-text').text(device.water+'%');
                    $('#device-'+device.serial_number+'-interval-text').text(device.interval+' detik');
                });
            }
        });
    }

    function load_devices(){
        $.ajax({
            url: '/api/device/my',
            type: 'GET',
            dataType: 'json',
            success: function(data){
                var devices = data.devices;
                var device_container = $('#device-container');
                device_container.empty();

                //if there is no device
                if(devices.length == 0){
                    device_container.append('<div class="col p-0">'+
                        '<div class="card p-3">'+
                            '<div class="text-center">'+
                                '<h5 class="text-muted">Tidak ada perangkat</h5>'+
                                '<p class="text-muted">Tambahkan perangkat baru dengan menekan tombol di bawah ini</p>'+
                                '<button class="btn btn-primary" id="btn-new_device"  data-bs-toggle="modal" data-bs-target="#exampleModal">Tambahkan Perangkat</button>'+
                            '</div>'+
                        '</div>'+
                    '</div>');
                    return;
                }
                
                for(var i=0; i<devices.length; i++){
                    var device = devices[i];
                    var device_html = '<div class="w-100 border rounded border-ni-ri mb-3 bg-light">';
                    device_html += '<div class="d-flex justify-content-between align-items-center p-2 border-bottom border-ni-ri">';
                    device_html += '<span class="fs-5 fw-bold" id="device-'+device.serial_number+'-name">'+device.name+'</span>';
                    device_html += '<span class="fs-6" id="device-'+device.serial_number+'-serial">'+device.serial_number+'</span>';
                    device_html += '</div>';
                    device_html += '<div class="d-flex justify-content-between align-items-center p-2 border-bottom border-ni-ri">';
                    device_html += '<div class="badge bg-primary px-3 py-1 fs-6 fw-regular" id="device-'+device.serial_number+'-radar">';
                    device_html += device.radar;
                    device_html += '</div>';
                    device_html += '<div class="badge bg-primary px-3 py-1 fs-6 fw-regular" id="device-'+device.serial_number+'-notification">';
                    device_html += '-';
                    device_html += '</div>';
                    device_html += '</div>';
                    device_html += '<div class="row row-cols-1 row-cols-md-3 m-0 p-2">';
                    device_html += '<div class="col ps-md-0 mb-2 mb-md-0">';
                    device_html += '<div class="d-flex justify-content-between fs-5">';
                    device_html += '<span>Baterai</span>';
                    device_html += '<span id="device-'+device.serial_number+'-battery-text">'+device.battery+'%</span>';
                    device_html += '</div>';
                    device_html += '<div class="progress">';
                    device_html += '<div class="progress-bar" role="progressbar" id="device-'+device.serial_number+'-battery" style="width: '+device.battery+'%" aria-valuenow="'+device.battery+'" aria-valuemin="0" aria-valuemax="100"></div>';
                    device_html += '</div>';
                    device_html += '</div>';
                    device_html += '<div class="col mb-2 mb-md-0">';
                    device_html += '<div class="d-flex justify-content-between fs-5">';
                    device_html += '<span>Cairan</span>';
                    device_html += '<span id="device-'+device.serial_number+'-water-text">'+device.water+'%</span>';
                    device_html += '</div>';
                    device_html += '<div class="progress">';
                    device_html += '<div class="progress-bar" role="progressbar" id="device-'+device.serial_number+'-water" style="width: '+device.water+'%" aria-valuenow="'+device.water+'" aria-valuemin="0" aria-valuemax="100"></div>';
                    device_html += '</div>';
                    device_html += '</div>';
                    device_html += '<div class="col pe-md-0 mb-2 mb-md-0">';
                    device_html += '<select class="form-select py-1 device-interval h-100" id="device-'+device.serial_number+'-interval">';
                    device_html += '<option value="-1">Interval : Always Off</option>';
                    device_html += '<option value="0">Interval : Always On</option>';
                    device_html += '<option value="5">Interval : 5 Detik</option>';
                    device_html += '<option value="15">Interval : 15 Detik</option>';
                    device_html += '<option value="30">Interval : 30 Detik</option>';
                    device_html += '</select>';
                    device_html += '</div>';
                    device_html += '</div>';
                    device_html += '<div class="d-flex justify-content-between p-2 border-top border-ni-ri flex-wrap">';
                    device_html += '<button class="btn btn-primary py-1" id="device-'+device.serial_number+'-btn-edit" onclick="edit_device(\''+device.serial_number+'\')">';
                    device_html += '<i class="bi bi-pencil"></i> Edit';
                    device_html += '</button>';
                    device_html += '<button class="btn btn-danger py-1" id="device-'+device.serial_number+'-btn-delete" onclick="delete_device(\''+device.serial_number+'\')">';
                    device_html += '<i class="bi bi-trash"></i> Delete';
                    device_html += '</button>';
                    device_html += '</div>';
                    device_html += '</div>';
                    device_html += '</div>';
                    device_container.append(device_html);

                    //set select interval
                    $('#device-'+device.serial_number+'-interval').val(device.interval);

                }
            }
        });
    }

    function delete_device(serial_number){
        //confirm
        var r = confirm("Apakah anda yakin ingin menghapus perangkat ini?");
        if (r == true) {
            $.ajax({
                url: '/api/device/delete',
                type: 'POST',
                data:{
                    serial_number: serial_number
                },
                dataType: 'json',
                success: function(data){
                    if(data.status == 'success'){
                        alert('Perangkat berhasil dihapus');
                        load_devices();
                    }
                    else{
                        alert('Gagal menghapus perangkat');
                    }
                }
            });
        }
    }

    function edit_device(serial_number){
        //open modal and set data
        $('#update-serial_number').val(serial_number);
        $('#update-name').val($('#device-'+serial_number+'-name').text());

        $('#update-modal').modal('show');
    }

    //on btn update name click
    $('#btn-update_name').click(function(){
        var serial_number = $('#update-serial_number').val();
        var name = $('#update-name').val();
        $.ajax({
            url: '/api/device/update',
            type: 'POST',
            data:{
                serial_number: serial_number,
                name: name
            },
            dataType: 'json',
            success: function(data){
                if(data.status == 'success'){
                    alert('Perangkat berhasil diubah');

                    //close modal and empty data
                    $('#update-modal').modal('hide');
                    $('#update-serial_number').val('');
                    $('#update-name').val('');

                    load_devices();
                }
                else{
                    alert('Gagal mengubah perangkat');
                }
            }
        });
    });

    //on select interval change of each device
    $(document).on('change', '.device-interval', function(){
        var serial_number = $(this).attr('id').split('-')[1];
        var interval = $(this).val();
        $.ajax({
            url: '/api/device/update/interval',
            type: 'POST',
            data:{
                serial_number: serial_number,
                interval: interval
            },
            dataType: 'json',
            success: function(data){
                if(data.status == 'success'){
                    alert('Perangkat berhasil diubah');
                    load_devices();
                }
                else{
                    alert('Gagal mengubah perangkat');
                }
            }
        });
    });

</script>

</html>